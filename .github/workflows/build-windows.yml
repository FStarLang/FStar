name: Build F* (Windows)

# Build F* on Windows

on:
  workflow_call:
  workflow_dispatch:
  push:

# defaults:
#   run:
#     shell:
#       bash
#       # ^ avoid powershell!

jobs:
  build-windows:
    # NOTE! Unlike our other builds, this requires a self-hosted
    # runner (for now?)
    runs-on: [self-hosted, Windows, X64, opam-2-3]

    steps:
      - uses: actions/checkout@master

      - name: Set version
        shell: C:\cygwin64\bin\bash.exe --login '{0}'
        run: |
          if [[ "${{github.workflow_ref}}" =~ "nightly.yml" ]]; then echo FSTAR_VERSION="nightly-$(date -I)" >> $GITHUB_ENV; elif [[ "${{github.workflow_ref}}" =~ "release.yml" ]]; then echo FSTAR_VERSION="$(cat version.txt)" >> $GITHUB_ENV; fi && echo "There is a CR at the end of this line"
      - run: find .
        shell: C:\cygwin64\bin\bash.exe --login '{0}'
      - name: Build package
        shell: C:\cygwin64\bin\bash.exe --login '{0}'
        run: |
          eval $(opam env) && CC=x86_64-w64-mingw32-gcc.exe make -skj$(nproc) package FSTAR_TAG=-Windows_NT-x86_64 V=1 && echo "There is a CR at the end of this line"
      - uses: actions/upload-artifact@v4
        with:
          path: fstar-Windows_NT-x86_64.tar.gz
          name: fstar-Windows_NT-x86_64.tar.gz
