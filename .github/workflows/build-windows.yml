name: Build F* (Windows)

# Full Windows build of F* (stage0 â†’ stage2) with tests.
# Uses ocaml/setup-ocaml with Cygwin for OCaml toolchain.

on:
  workflow_call:
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Cygwin
        uses: cygwin/cygwin-install-action@master
        with:
          packages: mingw64-i686-gmp, mingw64-i686-libffi, mingw64-x86_64-gmp, mingw64-x86_64-libffi
          site: https://mirrors.dotsrc.org/cygwin/

      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 4.14.2

      - name: Install Z3
        shell: bash
        run: |
          Z3_VERSION=4.13.3
          curl -L -o z3.zip "https://github.com/Z3Prover/z3/releases/download/z3-${Z3_VERSION}/z3-${Z3_VERSION}-x64-win.zip"
          unzip -q z3.zip
          mkdir -p ~/bin
          cp z3-*/bin/z3.exe ~/bin/
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Install opam dependencies
        run: opam install --deps-only ./fstar.opam -y

      - name: Set version
        shell: bash
        run: |
          if [[ "${{github.workflow_ref}}" == *"nightly.yml"* ]]; then
            echo "FSTAR_VERSION=nightly-$(date +%Y-%m-%d)" >> $GITHUB_ENV
          elif [[ "${{github.workflow_ref}}" == *"release.yml"* ]]; then
            echo "FSTAR_VERSION=$(cat version.txt)" >> $GITHUB_ENV
          fi

      - name: Build F* (stage0 â†’ stage2)
        shell: bash
        run: |
          make -skj$(nproc)

      - name: Verify F* works
        shell: bash
        run: |
          ./out/bin/fstar.exe --version

      - name: Run tests
        shell: bash
        run: |
          make test

      - name: Make binary package
        shell: bash
        run: |
          export FSTAR_TAG="-Windows_NT-x86_64"
          make package

      - name: List packages
        shell: bash
        run: |
          find . -name "*.zip" -type f

      - uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: package-win
          path: fstar-*.zip

  test:
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: package-win

      - name: Extract and test package
        shell: bash
        run: |
          unzip -q fstar-*.zip
          dir=$(ls -d fstar-* | head -1)
          ./$dir/fstar/bin/fstar.exe --version
          ./$dir/fstar/bin/fstar.exe $dir/fstar/lib/fstar/ulib/Prims.fst -f
          echo -e "module A\nopen FStar.Mul\nlet _ = assert (forall x. 1 + x*x > 0)" > A.fst
          ./$dir/fstar/bin/fstar.exe --already_cached "*,-A" A.fst
