name: Build F* (Windows)

# Build F* on Windows
# Note: this workflow is rather messy, prints a bunch of debugging info,
# and relies on a source package generated by a previous (Linux) job.
# Debugging Windows builds is a bit of a nightmare, and can fail in many
# subtle ways. Make sure to test any change thoroughly.
#
# At some point, this should just look exactly like the Linux and macos
# workflows, just running 'make package' in a proper environment, and
# doing a full bootstrapping build.
#
# NOTE: We use MSYS2 instead of Cygwin because setup-ocaml has a hardcoded
# Cygwin mirror (mirrors.kernel.org) that frequently fails with connection
# errors from GitHub Actions' cloud IPs.
# See: https://github.com/ocaml/setup-ocaml/issues/1038

on:
  workflow_call:
  workflow_dispatch:

jobs:
  # We begin from a source package (built in Linux)
  build-src:
    uses: ./.github/workflows/build-src.yml

  build:
    needs: build-src
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      # Setup MSYS2 - pre-installed on GitHub runners at C:\msys64
      # This bypasses the Cygwin mirror issue entirely
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            base-devel
            m4
            make
            patch
            diffutils
            git
            curl
            rsync
            unzip
            zip
            time
            pkg-config
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-gmp
            mingw-w64-ucrt-x86_64-libffi

      # Use the fork with MSYS2 support
      # See: https://github.com/ocaml/setup-ocaml/pull/857
      - uses: tobil4sk/setup-ocaml@feature/msys2
        with:
          ocaml-compiler: 4.14.2
          windows-environment: msys2
          cache-prefix: v6

      # Print out some debug info
      - name: dbg
        continue-on-error: true
        run: |
          echo 'uname -a'
          uname -a || true
          echo 'uname -s'
          uname -s || true
          echo 'uname -m'
          uname -m || true
          echo env
          env || true
          echo OS=$OS
          which make || true
          make --version || true

      # - name: Prepare
      #   shell: powershell # somehow in bash we fail to build ocamlfind?
      #   run: |
      #     ./FStar/.scripts/get_fstar_z3.sh $HOME/bin
      #     echo "PATH=$HOME/bin:$PATH" >> $GITHUB_ENV
      #     opam install --deps-only FStar\fstar.opam

      - name: Set version
        run: |
          # Setting FSTAR_VERSION for nightly and release builds. If unset,
          # we use $(version.txt)~dev. Setting it avoids the ~dev.
          if [[ "${{github.workflow_ref}}" =~ "nightly.yml" ]]; then
            echo FSTAR_VERSION="nightly-$(date -I)" >> $GITHUB_ENV
          elif [[ "${{github.workflow_ref}}" =~ "release.yml" ]]; then
            echo FSTAR_VERSION="$(cat FStar/version.txt)" >> $GITHUB_ENV
          fi

      # - name: Build packages
      #   working-directory: FStar
      #   run: |
      #     eval $(opam env)
      #     KERNEL=Windows_NT
      #     # $(uname -s)
      #     # ^ uname-s prints something like CYGWIN_NT-10.0-26100 or MINGW64_NT-10.0-20348
      #     ARCH=$(uname -m)
      #     export FSTAR_TAG=-$KERNEL-$ARCH
      #     make -kj$(nproc) 0 V=1
      #     echo -------------------------------------------------
      #     ./stage0/out/bin/fstar.exe --version
      #     ./stage0/out/bin/fstar.exe --locate
      #     ./stage0/out/bin/fstar.exe --locate_lib
      #     ./stage0/out/bin/fstar.exe --locate_ocaml
      #     ./stage0/out/bin/fstar.exe --include src --debug yes || true
      #     echo -------------------------------------------------
      #     make -kj$(nproc) package V=1

      # - uses: actions/upload-artifact@v4
      #   with:
      #     path: FStar\fstar-Windows_NT-x86_64.tar.gz
      #     name: fstar-Windows_NT-x86_64.tar.gz

      # Get source package, extract, install its OPAM deps.
      - uses: actions/download-artifact@v4
        with:
          name: package-src
      - run: tar xzf fstar-src.tar.gz
      - run: eval $(opam env) && opam install . --deps-only
        working-directory: fstar

      # Note: we admit queries here, like the OPAM build does.
      - name: Build
        run: |
          eval $(opam env)
          make ADMIT=1 -skj$(nproc)
        working-directory: fstar

      # F* was built in this MSYS2 environment, and can run. There is
      # somewhere a libgmp DLL that is being used, and that we must ship in
      # order for systems without this DLL to able to run F*. Using `which
      # libgmp-10.dll` returns a hit, but it seems to be (sometimes?) wrong and
      # point to a 32-bit version of the library that does not work. Here, we
      # use `ldd` to find out which dll we are using exactly, and ship that.
      - name: Find the right libgmp DLL
        run: |
          LIBGMP=$(ldd fstar/out/bin/fstar.exe | sed -n 's/^[[:space:]]*libgmp-10.dll => *\([^ ]*\) .*$/\1/p')
          echo "LIBGMP=$LIBGMP" >>$GITHUB_ENV

      - name: Make binary package
        run: |
          eval $(opam env)
          KERNEL=Windows_NT
          # $(uname -s)
          # ^ uname-s prints something like CYGWIN_NT-10.0-26100 or MINGW64_NT-10.0-20348
          ARCH=$(uname -m)
          export FSTAR_TAG=-$KERNEL-$ARCH
          make package
        working-directory: fstar

      - run: find . -name '*.zip'

      - uses: actions/upload-artifact@v4
        if: ${{ always () }}
        with:
          name: package-win
          path: fstar/fstar-*.zip

  test:
    needs: build
    runs-on: windows-latest
    steps:

      - uses: actions/download-artifact@v4
        with:
          name: package-win

      - name: Extract package
        shell: powershell
        run: |
          Expand-Archive -Path fstar-*.zip

      - name: Test fstar.exe
        shell: cmd
        run: |
          dir
          cd fstar-*
          .\fstar\bin\fstar.exe --version

      - name: Smoke test
        shell: powershell
        run: |
          cd fstar-*
          .\fstar\bin\fstar.exe fstar\lib\fstar\ulib\Prims.fst -f
          $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8' # Make sure we write UTF-8 files
          echo "module A`nopen FStar.Mul`nlet _ = assert (forall x. 1 + x*x > 0)" > A.fst
          .\fstar\bin\fstar.exe --already_cached *,-A A.fst
